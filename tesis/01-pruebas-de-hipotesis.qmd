# Pruebas de hipótesis {.unnumbered}

Uno de los pasos del **Análisis Exploratorio de Datos Espaciales** (_ESDA_ por
sus siglas en inglés) es probar si los datos geográficos cuentan con algún
tipo de estructura espacial. Hacerlo es importante ya que si en efecto existe
estructura espacial en los datos, entonces esta se debe incorporar en todo
el análisis.

Sin embargo, antes de entrar en detalle sobre qué es la estructura espacial
primero es importante definir su contraparte, la **aleatorieda espacial**
(_spatial randomness_).

## Aleatoriedad espacial

Es la ausencia de cualquier tipo de patrón espacial en los datos, y debe
satisfacer dos condiciones:

* Las observaciones son equiprobables de ocurrir en cualquer ubicación en el
espacio.
* El valor de una observación no depende de sus vecinos.

Para propósitos de análisis, es de interés encontrar evidencia en contra de
aleatoriedad espacial ya que esto indicaría que existe estructura espacial
en lo datos.

## Base de pruebas de hipótesis

Dado que es de interés encontrar evidencia en contra de aleatoriedad espacial,
entonces es posible apalancarse de la [1° ley geográfica de Tobler](https://en.wikipedia.org/wiki/Tobler%27s_first_law_of_geography)
para el planteamiento de una prueba hipótesis, misma que establece que en un
espacio geográfico "_Todo está relacionado con todo, pero las cosas más cercanas aún más_".
Bajo esta ley se pueden extraer dos conclusiones importantes:

1. En un contexto geográfico hay estructuras con dependencia espacial.
2. Existe decaemiento en la correlación de las cosas con la distancia, es
decir, observaciones más separadas estarán menos asociadas.

Estos puntos resultan en el planteamiento de la **prueba de hipótesis** básica
para datos geoespaciales:

* $H_0$: Los datos se distribuyen bajo aleatoriedad espacial.
* $H_1$: Los datos presentan algún tipo de estructura espacial.

Misma que se fundamenta en determinar la **autocorrelación espacial** de los
datos.

## Autocorrelación espacial

Busca medir la variación de una misma variable en ubicaciones distintas, y
puede tomar valores tanto positivos como negativos. Esto lleva a la
interpretación de tres posibles casos:

![Casos de autocorrelación espacial](./figuras/01/autocorrelacion_espacial.png)

* Autocorrelación **positiva**: Se da cuando las observaciones de una vecindad
tienen valores similares sean negativos (_cold spot_) o positivos (_hot spot_),
con mayor frecuencia que en aleatoriedad espacial, lo cual resulta en la
presencia de **segmentos geográficos** (_clusters_).

* Autocorrelación **nula**: No existe autocorrelación en los datos por lo que
hay aleatoriedad espacial.

* Autocorrelación **negativa**: Se da cuando las observaciones de una vecindad
tienen **valores alternantes** con mayor frecuencia que en aleatoriedad
espacial, lo cual resulta en estructuras tipo tablero de ajedrez.

### Estadísticos para autocorrelación espacial

Recordando que un **estadístico** es cualquier valor que resume alguna
característica de una distribución de referencia ($H_0$), entonces un
**estadístico de prueba** es aquel que se calcula de los datos y se compara con
esa misma distribución buscando responder a la pregunta:

>¿Qué tan probable es obtener el estadístico de prueba si éste proviniera
>de datos generados de la distribución de referencia $H_0$?

Éste entonces acepta o rechaza $H_0$ en función de si la probabilidad de
observar esos datos supera o no la región de rechazo en la distribución de
referencia.

Para construir un estadístico de prueba en un contexto espacial es
necesario que éste capture tanto la **similitud de atributos** como la
**similitud de ubicación** de una variable consigo misma pero en ubicaciones
distintas, de ahí que sea **auto**correlación en contraste con otros
estadísticos como pudiera ser la correlación de Pearson.

#### Similitud de atributos

Busca resumir la similitud de diferentes observaciones de una misma variable
$x$ en diferentes ubicaciones $i$, $j$, de modo que es una función
$f(x_i, x_j)$

#### Similitud de ubicación

Formaliza la noción de un vecino a través de los **pesos espaciales** 
($w_{ij}$) que se almacenan en la matriz de pesos espaciales $W$ a través
de algún tipo de interacción.

Con estas dos partes se puede construir un estadístico $z$ que sume a lo
largo de todos los pares de observaciones $(i, j)$ el producto de la similitud
de atributos con la similitud de ubicación, de modo que:

$$z = \sum_{ij}f(x_i,x_j)\cdot w_{ij}$$

::: {.callout-important}
A la hora de plantear estos enfoques se deriva una complicación fundamental
debida al **problema de parámetros incidentales**. Para entenderlo, se debe
recordar que la autocorrelación espacial se sustenta en definir la interacción
entre pares de observaciones para todas las $n\cdot(\frac{n-1}{2})$ duplas
posibles en un espacio geográfico.

La relación entre todos los posibles pares de observaciones se almacena en una
matriz de interacciones de dimensiones $n\times n$ siendo cada elemento un
parámetro del problema. Esto hace evidente que para un conjunto de $n$
observaciones, el número de parámetros crecería con un factor de $n^2$.
:::

### Pesos espaciales

La solución al problema anterior radica en imponer algún tipo de estructura a
los datos para limitar el número de parámetros por estimar, es aquí en donde
los **pesos espaciales** desempeñan un papel esencial al formalizar la noción
de vecinos. Fundamentalmente, los pesos espaciales están diseñados para
**excluir algunas interacciones** al limitar el número de vecinos de una
observación, por ejemplo, considerando aquellas ubicaciones con las que
comparte una frontera.

Entonces, el **grado de interacción** entre pares de observaciones queda
definido por un efecto combinado entre el **coeficiente de correlación**
(asociado a la similitud de atributos), y su **peso** (asociado a la similitud
de ubicación).

Una vez comprendida la definición de pesos, el siguiente paso es
construir la **matriz de pesos espaciales** basada en algún tipo de criterio,
que también es una matríz de dimensiones $n\times n$ en donde se almacena a
cada peso $w_{ij}$ y que cumple con las siguientes características:

* $w_{ij}\neq 0$ para vecinos.
* $w_{ij} = 0$ implica que $i$ y $j$ no son vecinos.
* $w_{ii} = 0$ dado que no hay similitud entre una observación consigo misma.

Esto provoca que $W$ sea una **matriz rala** ya que gran número de sus
elementos son $0$, estos anulan la interacción entre múltiples observaciones
reduciendo, consecuentemente, el número de parámetros por estimar.

#### Estandarización de pesos

Otro concepto importante en la definición de la matriz de pesos espaciales es
la **estandarización por renglón** de los pesos. Esto es que para cada renglón
de la matriz de pesos se hace el escalamiento:

$$w^*_{ij} = \frac{w_{ij}}{\sum_j w_{ij}}$$

De modo que:

$$\sum_j w^*_{ij} = 1$$

Lo anterior es importante debido a:

1. Se restringe el espacio parametral de los pesos.
2. Para todos los vecinos de una observación se sabe que la suma de los pesos
será uno.
3. Vuelve el análisis comparable de una observación a otra.
4. Permite hacer un cálculo posterior llamado **rezago espacial**, referente
al promedio de los vecinos.

Como referencia se puede considerar el siguiente ejemplo de una matriz con su
respectiva estandarización por renglón:

$$A = \begin{pmatrix}
1 & 0 & 0\\
1 & 1 & 0\\
1 & 1 & 1
\end{pmatrix} \rightarrow 
A^* = \begin{pmatrix}
1 & 0 & 0\\
1/2 & 1/2 & 0\\
1/3 & 1/3 & 1/3\\
\end{pmatrix}$$

### Criterios de contigüidad

Con lo anterior resta definir las reglas para construir la matriz de pesos
espaciales, para lo cual existen múltiples **criterios de contigüidad** que
se clasifican en dos categorías principales.

#### Criterios binarios

Se trata del tipo de criterio más simple, se asignan **pesos booleanos** a las
observaciones que comparten algún tipo de frontera física. El hecho de requerir
de una frontera implica que este tipo de criterio sea utilizado en
**polígonos** de modo que:

* $w_{ij}=0$: No se comparte frontera física
* $w_{ij}=1$: Se comparte alguna frontera

La siguiente figura ilustra la idea de un criterio binario de contigüidad:

![Ejemplo de una matriz de pesos basada en criterios de contigüidad binarios](./figuras/01/contiguidad_ejemplo.png){width=350}

Sin embargo, al construir la matriz de pesos utilizando criterios binarios se
tienen complicaciones que resultan en dos enfoques a la hora de definir el qué
es una frontera:

* Matriz de **contigüidad de torres** (_Rook_): Para la definición de
contigüidad considera únicamente **fronteras completas**. Su nombre es alusivo
al movimiento de una torre en ajedrez.

* Matriz de **contigüidad de reinas** (_Queen_): Para la definición de
contigüidad considera tanto **fronteras completas** como **esquinas**. Su
nombre es alusivo al movimiento de una reina en ajedrez.

De nueva cuenta, la siguiente figura ilustra la idea detras de ambos enfoques:

![Criterios de contigüidad](./figuras/01/criterios_contiguidad.png){width=350}

Considerando el elemento central en ambos casos, bajo el criterio de torres
los vecinos serían los elementos superior, inferior, izquiero, y derecho;
mientras que bajo el criterio de reinas todos los elementos serían vecinos.

#### Criterios basados en distancia

En general están basados en cualquier tipo de función de distancia lo cual
implica que su aplicación sea a **puntos**, por ejemplo, el centroide de
polígonos. Sin embargo, dado que una de las implicaciones de la
_1° Ley de Tobler_ es el **decaemiento por distancia** en la correlación de las
cosas, entonces no se podría utilizar directamente la distancia sino su
recíproco.

Algunos de los criterios de distancia más comunes en la práctica son:

* **Radio de cobertura**: Se debe definir un _buffer_ de cobertura basada en
una distancia de modo que aquellas observaciones dentro de cobertura son
vecinas y aquellas fuera de cobertura no:
    * $w_{ij} = 0$ si $d_{ij} > r$
    * $w_{ij} \neq 0$ si $d_{ij} \leq r$

    Sin embargo, existe un riesgo en la definición del radio de cobertura para
aquellos casos en que las regiones geográficas tienen tamaños muy diferentes
entre sí, y es que regiones pequeñas tengan demasiados vecinos, mientras que
regiones grandes tengan pocos vecinos.

    En el siguiente ejemplo, la región resaltada corre el riesgo de no tener
ningún vecino ya que la misma región puede ser más grande que el propio radio
del _buffer_.

![Ejemplo de regiones con tamaños diferentes entre sí](./figuras/01/mapa_1.png){width=250}

* **Vecinos más cercanos** (kNN): Surge como una solución al problema del
criterio anterior, y considera a los $k$ vecinos más cercanos a una observación
de interés independientemente de la distancia entre ellos, lo cual resulta en el
**mismo número de vecinos** para todas las observaciones.

### Histograma de conectividad

Una vez que se ha construido la matriz de pesos, se puede inspeccionar el
**histograma de conectividad** que no es más que un histograma del número de
vecinos por observación.

Alguno aspectos que se deben atender con detenimiento en un histograma de
conectividad son:

* Observaciones aisladas o sin vecinos, indican la presencia de islas ya sea
porque físicamente existe una isla o porque no hay datos entorno al registro
en cuestión.
* Número de vecinos inusualmente altos refleja una matriz de pesos que no
está desempeñándose correctamente, pues no consigue imponer suficiente
estructura a los datos para anular interacciones.
* Bimodalidad en la distribución.

## Autocorrelación espacial global


